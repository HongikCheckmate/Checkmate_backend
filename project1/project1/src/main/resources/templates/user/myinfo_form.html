<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>마이페이지</title>
    <!-- Bootstrap CSS CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">

    <style>
        body {
            background-color: white;
        }
        .form-container {
            max-width: 700px;
            margin: 100px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
<div class="form-container">
    <h1 class="mb-4">마이페이지</h1>
    <!-- Thymeleaf 속성(th:*)을 모두 제거하고 id를 부여합니다. -->
    <form id="updateForm">
        <div class="form-group">
            <label for="username">아이디</label>
            <!-- id와 name 속성을 사용합니다. 아이디는 수정 불가하도록 readonly 처리합니다. -->
            <input type="text" id="username" name="username" class="form-control" readonly />
        </div>
        <div class="form-group">
            <label for="nickname">닉네임</label>
            <input type="text" id="nickname" name="nickname" class="form-control">
        </div>
        <div class="form-group">
            <label for="email">이메일</label>
            <input type="email" id="email" name="email" class="form-control">
        </div>
        <div class="form-group">
            <label for="phone_number">전화번호</label>
            <input type="tel" id="phone_number" name="phone_number" class="form-control">
        </div>

        <button type="submit" class="btn btn-primary">수정하기</button>
    </form>
    <!-- 성공/실패 메시지를 표시할 영역 -->
    <div id="message" class="mt-3"></div>
</div>

<script>
    // 1. 페이지가 완전히 로드되면 실행될 함수를 등록합니다.
    document.addEventListener('DOMContentLoaded', function() {
        // localStorage에서 JWT 토큰을 가져옵니다.
        const token = localStorage.getItem('jwt-token');

        if (!token) {
            alert('로그인이 필요합니다.');
            window.location.href = '/user/login'; // 로그인 페이지로 리디렉션
            return;
        }

        // 2. 토큰을 헤더에 담아 내 정보 조회 API를 호출합니다.
        fetch('/api/user/mypage', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token
            }
        })
        .then(response => {
            if (response.status === 401) {
                throw new Error('인증에 실패했습니다. 다시 로그인해주세요.');
            }
            if (!response.ok) {
                throw new Error('정보를 불러오는 데 실패했습니다.');
            }
            return response.json();
        })
        .then(data => {
            // 3. API로부터 받은 데이터로 form의 각 필드를 채웁니다.
            document.getElementById('username').value = data.username || '';
            document.getElementById('nickname').value = data.nickname || '';
            document.getElementById('email').value = data.email || '';
            document.getElementById('phone_number').value = data.phone_number || '';
        })
        .catch(error => {
            console.error('Error:', error);
            alert(error.message);
            localStorage.removeItem('jwt-token'); // 잘못된 토큰은 삭제
            window.location.href = '/user/login';
        });
    });

    // 4. 정보 수정 form 제출 이벤트를 처리합니다.
    document.getElementById('updateForm').addEventListener('submit', function(event) {
        event.preventDefault(); // form의 기본 제출 동작(새로고침)을 막습니다.

        const token = localStorage.getItem('jwt-token');
        const messageDiv = document.getElementById('message');

        // form 필드에서 현재 값들을 가져와 객체로 만듭니다.
        const updatedData = {
            username: document.getElementById('username').value,
            nickname: document.getElementById('nickname').value,
            email: document.getElementById('email').value,
            phone_number: document.getElementById('phone_number').value
        };

        // 5. 수정할 데이터를 담아 정보 수정 API를 호출합니다.
        fetch('/api/user/mypage', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updatedData)
        })
        .then(response => {
            if (!response.ok) {
                // 서버에서 에러 메시지를 보냈다면 그 메시지를 사용합니다.
                return response.text().then(text => { throw new Error(text || '정보 수정에 실패했습니다.') });
            }
            // 성공 응답 (Bootstrap alert 스타일 사용)
            messageDiv.className = 'alert alert-success';
            messageDiv.textContent = '성공적으로 수정되었습니다.';
        })
        .catch(error => {
            console.error('Error:', error);
            // 실패 응답 (Bootstrap alert 스타일 사용)
            messageDiv.className = 'alert alert-danger';
            messageDiv.textContent = error.message;
        });
    });
</script>

</body>
</html>