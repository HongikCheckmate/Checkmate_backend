<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>회원 가입</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">

    <style>
        body {
          background-color: white;
        }
        .form-container {
            max-width: 700px;
            margin: 100px auto;
            padding: 20px;
        }
        .form-title {
            text-align: center;
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
<div class="form-container">
    <h2 class="form-title">회원가입</h2>
    <!--
      - th:* 속성을 제거하고 id를 부여합니다.
      - form의 action과 method는 JavaScript로 처리하므로 제거합니다.
    -->
    <form id="signupForm">
        <div class="form-group">
            <label class="form-label text-black" for="username">아이디</label>
            <input type="text" id="username" name="username" class="form-control" required>
            <!-- 에러 메시지를 표시할 div (JavaScript로 제어) -->
            <div id="username-error" class="text-danger"></div>
        </div>
        <div class="form-group">
            <label class="form-label text-black" for="password">비밀번호</label>
            <input type="password" id="password" name="password" class="form-control" required>
            <div id="password-error" class="text-danger"></div>
        </div>
        <div class="form-group">
            <label class="form-label text-black" for="check_password">비밀번호 확인</label>
            <input type="password" id="check_password" name="check_password" class="form-control" required>
            <div id="check_password-error" class="text-danger"></div>
        </div>
        <div class="form-group">
            <label class="form-label text-black" for="nickname">닉네임</label>
            <input type="text" id="nickname" name="nickname" class="form-control" required>
            <div id="nickname-error" class="text-danger"></div>
        </div>
        <div class="form-group">
            <label class="form-label text-black" for="email">이메일</label>
            <input type="email" id="email" name="email" class="form-control" required>
            <div id="email-error" class="text-danger"></div>
        </div>
        <div class="form-group">
            <label class="form-label text-black" for="phone_number">전화번호</label>
            <input type="tel" id="phone_number" name="phone_number" class="form-control" required>
            <div id="phone_number-error" class="text-danger"></div>
        </div>

        <!-- 전체적인 성공/실패 메시지를 표시할 영역 -->
        <div id="global-message" class="mt-3"></div>

        <button type="submit" class="btn btn-primary">회원가입</button>
    </form>
</div>
</body>
<script>
    document.getElementById('signupForm').addEventListener('submit', function(event) {
        event.preventDefault(); // form의 기본 제출 동작(새로고침)을 막습니다.

        const globalMessageDiv = document.getElementById('global-message');
        const passwordInput = document.getElementById('password');
        const checkPasswordInput = document.getElementById('check_password');
        const checkPasswordErrorDiv = document.getElementById('check_password-error');

        // 이전 에러 메시지 초기화
        document.querySelectorAll('.text-danger').forEach(el => el.textContent = '');
        globalMessageDiv.innerHTML = '';

        // 폼 데이터 객체 생성
        const formData = {
            username: document.getElementById('username').value,
            nickname: document.getElementById('nickname').value,
            email: document.getElementById('email').value,
            phone_number: document.getElementById('phone_number').value,
            password: passwordInput.value,
            check_password: checkPasswordInput.value
        };

        // 클라이언트 단에서 비밀번호 일치 여부 먼저 확인
        if (formData.password !== formData.check_password) {
            checkPasswordErrorDiv.textContent = '비밀번호가 일치하지 않습니다.';
            checkPasswordInput.focus();
            return;
        }

        // 회원가입 API(/api/user/signup) 호출
        fetch('/api/user/signup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
        .then(async response => {
            const responseText = await response.text();
            if (!response.ok) {
                // 서버에서 보낸 에러 메시지를 기반으로 Error 발생
                throw new Error(responseText || '회원가입 처리 중 오류가 발생했습니다.');
            }
            return responseText;
        })
        .then(data => {
            // 성공 처리
            globalMessageDiv.className = 'alert alert-success';
            globalMessageDiv.textContent = data; // 서버의 성공 메시지
            alert('회원가입에 성공했습니다! 로그인 페이지로 이동합니다.');
            window.location.href = '/user/login'; // 로그인 페이지로 리디렉션
        })
        .catch(error => {
            // 실패 처리
            console.error('Error:', error);
            globalMessageDiv.className = 'alert alert-danger';
            // 서버에서 받은 에러 메시지를 표시
            globalMessageDiv.textContent = error.message;
        });
    });
</script>
</html>